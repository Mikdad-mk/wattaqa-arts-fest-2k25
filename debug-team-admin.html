<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Team Admin Debug</title>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; background: #f5f5f5; }
        .container { max-width: 1200px; margin: 0 auto; }
        .debug-panel { background: white; padding: 20px; margin: 10px 0; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .stats { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin: 20px 0; }
        .stat-card { background: white; padding: 20px; border-radius: 8px; text-align: center; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .stat-number { font-size: 2em; font-weight: bold; margin-bottom: 5px; }
        .stat-label { color: #666; font-size: 0.9em; }
        .programme-card { background: white; border: 2px solid #ddd; border-radius: 8px; padding: 15px; margin: 10px 0; }
        .programme-card.registered { border-color: #10b981; background: #f0fdf4; }
        .programme-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 15px; }
        .section-header { background: #3b82f6; color: white; padding: 15px; border-radius: 8px; margin: 20px 0 10px 0; }
        .team-selector { margin: 20px 0; }
        .team-selector select { padding: 10px; font-size: 16px; border-radius: 4px; border: 1px solid #ddd; }
        .error { background: #fee2e2; border: 1px solid #fecaca; color: #dc2626; padding: 15px; border-radius: 8px; margin: 10px 0; }
        .success { background: #f0fdf4; border: 1px solid #bbf7d0; color: #16a34a; padding: 15px; border-radius: 8px; margin: 10px 0; }
    </style>
</head>
<body>
    <div class="container">
        <h1>üèÉ Team Admin Debug Tool</h1>
        
        <div class="team-selector">
            <label for="teamSelect">Select Team:</label>
            <select id="teamSelect" onchange="loadTeamData()">
                <option value="SMD">SMD (SUMUD)</option>
                <option value="INT">INT (INTIFADA)</option>
                <option value="AQS">AQS (AQSA)</option>
            </select>
        </div>

        <div id="loading" style="display: none;">
            <div class="debug-panel">
                <h3>üîÑ Loading...</h3>
                <p>Fetching team data...</p>
            </div>
        </div>

        <div id="error" style="display: none;" class="error">
            <h3>‚ùå Error</h3>
            <p id="error-message"></p>
        </div>

        <div id="results" style="display: none;">
            <div class="debug-panel">
                <h3>üìä API Response Debug</h3>
                <div id="api-debug"></div>
            </div>

            <div class="stats">
                <div class="stat-card">
                    <div class="stat-number" style="color: #3b82f6;" id="available-count">0</div>
                    <div class="stat-label">Available Programmes</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" style="color: #10b981;" id="registered-count">0</div>
                    <div class="stat-label">Registered</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" style="color: #f59e0b;" id="unregistered-count">0</div>
                    <div class="stat-label">Not Registered</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" style="color: #8b5cf6;" id="candidates-count">0</div>
                    <div class="stat-label">Team Candidates</div>
                </div>
            </div>

            <div class="section-header">
                <h3>üìã Programme Registration Status</h3>
            </div>

            <div id="programmes-list" class="programme-grid">
                <!-- Programmes will be loaded here -->
            </div>
        </div>
    </div>

    <script>
        let currentTeam = 'SMD';

        async function loadTeamData() {
            const teamSelect = document.getElementById('teamSelect');
            currentTeam = teamSelect.value;
            
            document.getElementById('loading').style.display = 'block';
            document.getElementById('error').style.display = 'none';
            document.getElementById('results').style.display = 'none';

            try {
                console.log(`üîÑ Loading data for team: ${currentTeam}`);

                // Simulate the API calls that the real app makes
                const [candidatesRes, programmesRes, participantsRes] = await Promise.all([
                    fetch(`/api/candidates?team=${currentTeam}`),
                    fetch('/api/programmes'),
                    fetch(`/api/programme-participants?team=${currentTeam}`)
                ]);

                const [candidates, programmes, participants] = await Promise.all([
                    candidatesRes.json(),
                    programmesRes.json(),
                    participantsRes.json()
                ]);

                console.log('üìä API Responses:', { candidates: candidates.length, programmes: programmes.length, participants: participants.length });

                // Show API debug info
                document.getElementById('api-debug').innerHTML = `
                    <p><strong>GET /api/candidates?team=${currentTeam}</strong> ‚Üí ${candidates.length} candidates</p>
                    <p><strong>GET /api/programmes</strong> ‚Üí ${programmes.length} programmes</p>
                    <p><strong>GET /api/programme-participants?team=${currentTeam}</strong> ‚Üí ${participants.length} registrations</p>
                `;

                // Calculate statistics like the real app
                const teamSections = [...new Set(candidates.map(c => c.section))];
                const availableProgrammes = programmes.filter(p => {
                    if (p.section === 'general') return true;
                    return teamSections.includes(p.section);
                });

                const registeredCount = participants.length;
                const availableCount = availableProgrammes.length;
                const unregisteredCount = availableCount - registeredCount;

                // Update statistics
                document.getElementById('available-count').textContent = availableCount;
                document.getElementById('registered-count').textContent = registeredCount;
                document.getElementById('unregistered-count').textContent = unregisteredCount;
                document.getElementById('candidates-count').textContent = candidates.length;

                // Show programmes
                const programmesList = document.getElementById('programmes-list');
                programmesList.innerHTML = '';

                availableProgrammes.forEach(programme => {
                    const isRegistered = participants.some(p => p.programmeId === programme._id);
                    const registration = participants.find(p => p.programmeId === programme._id);
                    
                    // Count eligible candidates
                    let eligibleCandidates = [];
                    if (programme.section === 'general') {
                        eligibleCandidates = candidates;
                    } else {
                        eligibleCandidates = candidates.filter(c => c.section === programme.section);
                    }

                    const programmeCard = document.createElement('div');
                    programmeCard.className = `programme-card ${isRegistered ? 'registered' : ''}`;
                    programmeCard.innerHTML = `
                        <h4>${programme.name}</h4>
                        <p><strong>Code:</strong> ${programme.code}</p>
                        <p><strong>Section:</strong> ${programme.section}</p>
                        <p><strong>Category:</strong> ${programme.category}</p>
                        <p><strong>Required Participants:</strong> ${programme.requiredParticipants}</p>
                        <p><strong>Eligible Candidates:</strong> ${eligibleCandidates.length}</p>
                        <p><strong>Status:</strong> ${isRegistered ? '‚úÖ REGISTERED' : '‚≠ï NOT REGISTERED'}</p>
                        ${isRegistered ? `<p><strong>Registered Participants:</strong> ${registration.participants.join(', ')}</p>` : ''}
                        ${eligibleCandidates.length < programme.requiredParticipants ? '<p style="color: red;">‚ùå Insufficient candidates to register</p>' : ''}
                    `;
                    programmesList.appendChild(programmeCard);
                });

                document.getElementById('loading').style.display = 'none';
                document.getElementById('results').style.display = 'block';

                // Show success message if everything looks good
                if (registeredCount > 0) {
                    const successDiv = document.createElement('div');
                    successDiv.className = 'success';
                    successDiv.innerHTML = `
                        <h3>‚úÖ System Working Correctly</h3>
                        <p>Found ${registeredCount} registrations for team ${currentTeam}. The team admin page should show these as registered programmes with green backgrounds.</p>
                    `;
                    document.getElementById('results').insertBefore(successDiv, document.getElementById('programmes-list'));
                }

            } catch (error) {
                console.error('‚ùå Error loading data:', error);
                document.getElementById('error-message').textContent = error.message;
                document.getElementById('loading').style.display = 'none';
                document.getElementById('error').style.display = 'block';
            }
        }

        // Load initial data
        loadTeamData();
    </script>
</body>
</html>